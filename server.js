import express from 'express';
import fetch from 'node-fetch';
import cors from 'cors';

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static('.')); // Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸ÐºÐ¸ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°

const HF_TOKEN = process.env.HF_TOKEN; // Ð£Ð±ÐµÐ´Ð¸ÑÑŒ, Ñ‡Ñ‚Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ HF_TOKEN Ð·Ð°Ð´Ð°Ð½Ð°
const MODEL = "mistralai/Mistral-7B-Instruct-v0.2"; // Ð¸Ð»Ð¸ Ð»ÑŽÐ±ÑƒÑŽ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚

const PORT = process.env.PORT || 3000;

app.post('/api/build', async (req, res) => {
    const { budget, gpu, cpu, tasks } = req.body;

    const prompt = `
ÐŸÐ¾Ð´Ð±ÐµÑ€Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÐ±Ð¾Ñ€ÐºÑƒ ÐŸÐš.
Ð‘ÑŽÐ´Ð¶ÐµÑ‚: ${budget} Ñ€ÑƒÐ±.
Ð’Ð¸Ð´ÐµÐ¾ÐºÐ°Ñ€Ñ‚Ð°: ${gpu}
ÐŸÑ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€: ${cpu}
ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: ${tasks}

Ð’Ñ‹Ð²ÐµÐ´Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚ÑƒÑŽÑ‰Ð¸Ñ…:
CPU, GPU, ÐºÑƒÐ»ÐµÑ€, Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð½ÑÐºÐ°Ñ Ð¿Ð»Ð°Ñ‚Ð°, ÐºÐ¾Ñ€Ð¿ÑƒÑ, Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¸Ð²Ð½Ð°Ñ Ð¿Ð°Ð¼ÑÑ‚ÑŒ, Ð½Ð°ÐºÐ¾Ð¿Ð¸Ñ‚ÐµÐ»ÑŒ, Ð±Ð»Ð¾Ðº Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ Ð¸ Ñ‚.Ð´.
Ð£ÐºÐ°Ð¶Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ñ‹Ðµ Ñ†ÐµÐ½Ñ‹ Ð² Ñ€ÑƒÐ±Ð»ÑÑ… Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°.
Ð¡Ð´ÐµÐ»Ð°Ð¹ Ñ‚ÐµÐºÑÑ‚ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¼ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ, ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸.
`;

    try {
        const response = await fetch(`https://router.huggingface.co/models/${MODEL}`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${HF_TOKEN}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                inputs: prompt,
                parameters: {
                    max_new_tokens: 800,
                    temperature: 0.7
                }
            })
        });

        const data = await response.json();

        if (data.error) {
            console.error("HF Router error:", data);
            return res.status(500).json({ result: `âŒ HF Router error: ${data.error}` });
        }

        // Mistral Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð² Ñ generated_text
        const text = data[0]?.generated_text || "âŒ ÐÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸";
        res.json({ result: text });

    } catch (err) {
        console.error("Server error:", err);
        res.status(500).json({ result: "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ." });
    }
});

app.listen(PORT, () => {
    console.log(`ðŸš€ Server running on port ${PORT}`);
});
